<script type="text/javascript"><!--
      var VARS = VARS || {};
      var USERINFO = USERINFO || {};
      
      window.onload = function(){
      
        try{
          // キャッシュ情報でログイン試行
          if(document.cookie.split("userToken=")[1].split(";")[0]){
            autoLogin();
            loadExpenseItemSelect();
          }else{
            initialize();
          }
        }catch(e){
          console.log(e);
          initialize();
        }
      }
      
      function autoLogin(){
         let id    = document.cookie.split("userId=")[1].split(";")[0];
         let token = document.cookie.split("userToken=")[1].split(";")[0];

         google.script.run.withSuccessHandler(loginOk)
                         .withFailureHandler(gasFailure)
                         .userAuthByToken(id,token);
        function loginOk(canLogin){
          if(canLogin){
            //showRichAlert("認証成功");
            USERINFO.id     = id;
            USERINFO.token  = token;
            switchSec("mainSec");
          }else{
            logout();
          }
          hideLoading();
        }
      }
      
      function initialize(){
        hideLoading();
        switchSec("loginSec");
        document.getElementById("userId").value = document.cookie.split("userId=")[1].split(";")[0];
      }
      
      function gasFailure(){
        showRichAlert("実行に失敗しました．時間をおいて再実行してください．");
        initialize();
      }
      
      // cookie参考：https://so-zou.jp/web-app/tech/programming/javascript/cookie/ 
      function loginByForm(){
        let inputtedId   = getElemValById("userId");
        let inputtedPass = getElemValById("password");
        let hashedPass   = sha256(inputtedPass);
        login(inputtedId,hashedPass);
      }
      
      function login(loginId,loginPass){
        showLoading();
        var remember  = document.getElementById("rememberUser").checked;
        google.script.run.withSuccessHandler(loginOk)
                         .withFailureHandler(gasFailure)
                         .userAuthByPass(loginId,loginPass);
        function loginOk(token){
          if(token){
            //showRichAlert("認証成功");
            USERINFO.id     = loginId;
            USERINFO.token  = token;
            if(remember){
              document.cookie = "userId="    + encodeURIComponent(loginId) + ";max-age=864000"; //有効期限10日間
              document.cookie = "userToken=" + encodeURIComponent(token)   + ";max-age=864000";
            }
            switchSec("mainSec");
          }else{
            showRichAlert("認証失敗");
            logout();
          }
          hideLoading();
        }
      }
      
      function logout(){
        document.cookie = "userToken=;max-age=0";
        initialize();
      }
      
      function switchSec(id){
        var sectionIds = ["loginSec","mainSec"];
        for(let i=sectionIds.length-1;i>=0;i--){
          hideElemById(sectionIds[i]);
        }
        showElemById(id,"block");
      }
      
      
      function loadExpenseItemSelect(){
         google.script.run.withSuccessHandler(loadOk)
                          .withFailureHandler(gasFailure)
                          .loadExpenseItem();
        function loadOk(expenseItem){
          document.getElementById("expenseItemDiv").innerHTML=expenseItem;
        }
      }
      
      
      
      
      
      
      
      
      //google.script.run.withSuccessHandler(loadState).sendToHtml_state();
      function getElemValById(id)      {return document.getElementById(id).value;}  
      
      function showElemById(id,display){document.getElementById(id).style.display=display;} 
      function hideElemById(id)        {document.getElementById(id).style.display="none";}  
      
      function showLoading(){document.getElementById("loader").style.display="flex";}
      function hideLoading(){document.getElementById("loader").style.display="none";}
      
      function showRichAlert(str){    
        hideRichAlert();
        document.getElementById("richAlert").style.display="flex";
        document.getElementById("richAlertText").innerHTML=str;
        document.getElementById("richAlertClose").focus();
      }
      function hideRichAlert(){
        document.getElementById("richAlert").style.display="none";
      }
      
// --></script>