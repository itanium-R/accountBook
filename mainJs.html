<script type="text/javascript"><!--
      var VARS = VARS || {};
      var USERINFO = USERINFO || {};
      
      window.onload = function(){
        try{
          // キャッシュ情報でログイン試行
          if(document.cookie.split("userPass=")[1].split(";")[0]){
            autoLogin();
          }else{
            initialize();
          }
        }catch(e){
          console.log(e);
          initialize();
        }
      }
      function autoLogin(){
         loginId   = document.cookie.split("userId=")[1].split(";")[0];
         loginPass = document.cookie.split("userPass=")[1].split(";")[0];
         login(loginId,loginPass);
      }
      
      function initialize(){
        swichSec("loginSec");
        document.getElementById("userId").value = document.cookie.split("userId=")[1].split(";")[0];
      }
      
      function gasFailure(){
        showRichAlert("実行に失敗しました．再実行してください．");
        hideLoading();
      }
      
      // cookie参考：https://so-zou.jp/web-app/tech/programming/javascript/cookie/
      
      function loginByForm(){
        var loginId   = getElemValById("userId");
        var loginPass = getElemValById("password");
        login(loginId,loginPass);
      }
      
      
      function login(loginId,loginPass){
        showLoading();
        var remember  = document.getElementById("rememberUser").checked;
        google.script.run.withSuccessHandler(loginOk)
                         .withFailureHandler(gasFailure)
                         .userAuth(loginId,loginPass);
        function loginOk(canLogin){
          if(canLogin){
            //showRichAlert("認証成功");
            USERINFO.id     = loginId;
            USERINFO.pass   = loginPass;
            if(remember){
              document.cookie = "userId="   + encodeURIComponent(loginId)  +" ;max-age=2592000";
              document.cookie = "userPass=" + encodeURIComponent(loginPass)+" ;max-age=2592000";
            }
            swichSec("mainSec");
          }else{
            showRichAlert("認証失敗");
            initialize();
          }
          hideLoading();
        }
        //TODO:ハッシュ関数の利用
      }
      
      function logout(){
        document.cookie = "userPass=;max-age=0";
        initialize();
      }
      
      function swichSec(id){
        var sectionIds = ["loginSec","mainSec"];
        for(let i=sectionIds.length-1;i>=0;i--){
          hideElemById(sectionIds[i]);
        }
        showElemById(id,"block");
      }
      
      //google.script.run.withSuccessHandler(loadState).sendToHtml_state();
      function getElemValById(id)      {return document.getElementById(id).value;}  
      
      function showElemById(id,display){document.getElementById(id).style.display=display;} 
      function hideElemById(id)        {document.getElementById(id).style.display="none";}  
      
      function showLoading(){document.getElementById("loader").style.display="flex";}
      function hideLoading(){document.getElementById("loader").style.display="none";}
      
      function showRichAlert(str){    
        hideRichAlert();
        document.getElementById("richAlert").style.display="flex";
        document.getElementById("richAlertText").innerHTML=str;
        document.getElementById("richAlertClose").focus();
      }
      function hideRichAlert(){
        document.getElementById("richAlert").style.display="none";
      }
      
// --></script>